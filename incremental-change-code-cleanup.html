<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.6 at 2017-04-26 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>obevo-site &#x2013; Incremental Change Code Cleanup</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20170426" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                obevo-site
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                    
                <div class="xleft">
        <span id="publishDate">Last Published: 2017-04-26</span>
                  &nbsp;| <span id="projectVersion">Version: 6.0.0-SNAPSHOT</span>
                      </div>
            <div class="xright">                    <a href="./" title="obevo-site">obevo-site</a>
              
                    
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                    
                                <h5>Parent Project</h5>
                  <ul>
                  <li class="none">
                          <a href="../index.html" title="Obevo Parent POM">Obevo Parent POM</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                                                                            <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                   
                    
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        
    
        
            
            
        <ul>
<li><a href="#Rebaselining_CHANGE_entries_in_your_table_files">Rebaselining CHANGE entries in your table files</a></li>
<li><a href="#How_to_update_your_Obevo_db_file_if_you_have_to_do_a_manual_SQL_change_without_a_release_not_that_you_should_try_this">How to update your Obevo db file if you have to do a manual SQL change without a release (not that you should try this)</a></li>
<li><a href="#Deprecate">Deprecate</a></li></ul>
        
<p>The key Obevo rule for handling incremental object types (e.g. tables with //// CHANGE) is to never
            modify/delete an already deployed change. There are exceptional cases where you may want to do this for
            the purposes of code cleanup. This page describes how to do those cleanups.
        </p>
        
<div class="section">
<h2><a name="Rebaselining_CHANGE_entries_in_your_table_files"></a>Rebaselining CHANGE entries in your table files</h2>
            
<div class="section">
<h3><a name="Use_Case_Details"></a>Use Case Details</h3>
                
<p>For table files and changes - as Obevo requires that all new changes are additions to the
                    file, this
                    file may end up being pretty long (see the section below (to be written) on the justifications for
                    this).
                </p>
                
<p>At some point, your team may want to &quot;rebaseline&quot; your table change file, i.e. get rid of
                    all the
                    old individual changes in the file and replace the content w/ the latest version of the table, so
                    that any
                    changes going forward (and all people reading the db files) can look at the cleaner latest view
                    instead.
                </p>
            </div>
            
<div class="section">
<h3><a name="High_Level_Steps_To_Execute"></a>High Level Steps To Execute</h3>
                
<p>To do this for a particular table file, you must:</p>
                
<ol style="list-style-type: decimal">
                    
<li>Get the list of change names currently in your file</li>
                    
<li>Create a new //// CHANGE entry, with a new change name and the additional attribute &quot;baselinedChanges=chng1,chng2,chng3&quot;
                        with your change names comma-separted
                    </li>
                    
<li>Add your new baselined sql under this change and delete the rest</li>
                </ol>
            </div>
            
<div class="section">
<h3><a name="Example"></a>Example</h3>
                
<p>Note - you can also check out <a href="${source.webroot}/obevo-db-impls/obevo-db-scenario-tests/src/test/resources/scenariotests/baseline-scenario" class="externalLink">the example</a> in the source code -
                    the snippets below are similar examples. The different step folders represent the evolution of the table
                </p>
                
<p>Step 1 - let's say that you start w/ a table like so:</p>
                
<div class="source">
<pre>//// CHANGE name=chng1
CREATE TABLE TABLE_A (
    A_ID INT NOT NULL,
    B_ID INT NULL
)
GO

//// CHANGE FK name=fkChange
ALTER TABLE TABLE_A ADD FOREIGN KEY (B_ID) REFERENCES TABLE_B(B_ID)
GO

//// CHANGE name=index
CREATE INDEX TABLE_A_IND1 ON TABLE_A (A_ID, B_ID)

//// CHANGE name=chng2
ALTER TABLE TABLE_A ADD COLUMN C_ID INT NULL
GO

//// CHANGE name=chng3
ALTER TABLE TABLE_A ADD COLUMN D_ID INT NULL
GO</pre></div>
                
<p>And let's say that you want to rebaseline this to look like the latest version, e.g. with the columns C and D already added:</p>
                
<div class="source">
<pre>CREATE TABLE TABLE_A (
    A_ID INT NOT NULL,
    B_ID INT NULL,
    C_ID INT NULL,
    D_ID INT NULL
)
GO

ALTER TABLE TABLE_A ADD FOREIGN KEY (B_ID) REFERENCES TABLE_B(B_ID)
GO

CREATE INDEX TABLE_A_IND1 ON TABLE_A (A_ID, B_ID)
GO</pre></div>
                
<p>Step 2 - collect the changes to rebaseline: Note that the names of the changes are chng1, chng2,
                    chng3, index
                    - we want to combine these into one. (the foreign key needs to be separate so that it can be
                    deployed
                    separately due to the ordering algorithm.
                </p>
                
<p>The resulting file would look as follows:</p>
                
<div class="source">
<pre>//// CHANGE name=rebaselined baselinedChanges=chng1,chng2,chng3,index
CREATE TABLE TABLE_A (
    A_ID INT NOT NULL,
    B_ID INT NULL,
    C_ID INT NULL,
    D_ID INT NULL
)
GO

CREATE INDEX TABLE_A_IND1 ON TABLE_A (A_ID, B_ID)
GO

//// CHANGE FK name=fkChange
ALTER TABLE TABLE_A ADD FOREIGN KEY (B_ID) REFERENCES TABLE_B(B_ID)
GO</pre></div>
                
<p>Step 3 - Perform a deployment that includes this file change. The deployment will be a no-op for the
                    physical
                    table, but the audit table will reflect the changes in your baseline
                </p>
                
<p>Step 4 - Once you've done a deploy to all your environments and thus removed the original change
                    entries in
                    your audit table, you can safely delete the baselinedChanges attribute, e.g.
                </p>
                
<div class="source">
<pre>//// CHANGE name=rebaselined baselinedChanges=chng1,chng2,chng3,index
CREATE TABLE TABLE_A (
    A_ID INT NOT NULL,
    B_ID INT NULL,
    C_ID INT NULL,
    D_ID INT NULL
)
GO

CREATE INDEX TABLE_A_IND1 ON TABLE_A (A_ID, B_ID)
GO

//// CHANGE FK name=fkChange
ALTER TABLE TABLE_A ADD FOREIGN KEY (B_ID) REFERENCES TABLE_B(B_ID)
GO</pre></div>
            </div>
            
<div class="section">
<h3><a name="Potential_Improvements_on_the_existing_approach"></a>Potential Improvements on the existing approach</h3>
                
<p>Now that you have done this - great, now you have a much smaller baselined file!</p>
                
<p>However, one issue we'd like to improve in this process: how did you come up with that rebaselined sql?</p>
                
<ul>
                    
<li>Did you re-query it from the database, or figure it out yourself?</li>
                    
<li>How do you truly know that your rebaselined SQL matches the CHANGEs that you used to deploy this
                        in the
                        first place?
                    </li>
                </ul>
                
<p>There are two potential things to try for here:</p>
                
<ol style="list-style-type: decimal">
                    
<li>A nice way to generate the rebaselined SQL (or to derive it from another authoritative
                        source...)
                    </li>
                    
<li>A programmatic way to compare the original changes vs. the baseline</li>
                </ol>
                
<p>The next section goes through this</p>
            </div>
        </div>
        
<div class="section">
<h2><a name="How_to_update_your_Obevo_db_file_if_you_have_to_do_a_manual_SQL_change_without_a_release_not_that_you_should_try_this"></a>How to update your Obevo db file if you have to do a manual SQL change without a release (not that you should try this)</h2>
            
<p>don't do it often! there are alternatives to doing it manually</p>
            
<p>section to be written</p>
        </div>
        
<div class="section">
<h2><a name="Deprecate"></a>Deprecate</h2>
            to be added

        </div>
    

      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2017
                        <a href="http://www.goldmansachs.com/">Goldman Sachs</a>.
            All rights reserved.      
                    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
