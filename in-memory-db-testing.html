<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2017-12-04 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20171204" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Obevo &#x2013; In-memory DB Conversion for Unit Testing</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
      <script type="text/javascript" src="./js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarEnabled">
                      <a href="https://github.com/goldmansachs/obevo">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"
        alt="Fork me on GitHub">
    </a>
      <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
            <ul class="nav">
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Getting Started <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="index.html" title="Intro">Intro</a></li>
            <li><a href="overview.html" title="Overview">Overview</a></li>
            <li><a href="setup.html" title="Setup">Setup</a></li>
            <li><a href="support.html" title="Help and Support">Help and Support</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Technical Documentation <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="db-project-structure.html" title="DB Project Structure">DB Project Structure</a></li>
            <li><a href="environment-management.html" title="Environment Management">Environment Management</a></li>
            <li><a href="permission-management.html" title="Permission Management">Permission Management</a></li>
            <li><a href="error-handling.html" title="Error-Handling">Error-Handling</a></li>
            <li><a href="command-line-api.html" title="Command-line API">Command-line API</a></li>
            <li><a href="java-api.html" title="Java API">Java API</a></li>
            <li><a href="maven-api.html" title="Maven plugin API">Maven plugin API</a></li>
            <li><a href="gradle-api.html" title="Gradle API">Gradle API</a></li>
            <li><a href="faq.html" title="FAQs">FAQs</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Advanced Topics <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="db-project-best-practices.html" title="DB Project Best Practices">DB Project Best Practices</a></li>
            <li><a href="rollback.html" title="Rollback">Rollback</a></li>
            <li><a href="multiple-schema-management.html" title="Multiple Schema Management">Multiple Schema Management</a></li>
            <li><a href="in-memory-db-testing.html" title="In-memory DB Testing">In-memory DB Testing</a></li>
            <li><a href="parallel-deploy-execution.html" title="Parallel Deploy Execution">Parallel Deploy Execution</a></li>
            <li><a href="orm-integration.html" title="ORM Integration">ORM Integration</a></li>
            <li><a href="baseline-validation.html" title="Baseline DDL Validation">Baseline DDL Validation</a></li>
            <li><a href="sybase-ase-notes.html" title="Sybase ASE Notes">Sybase ASE Notes</a></li>
            <li><a href="db2-notes.html" title="DB2 Notes">DB2 Notes</a></li>
            <li><a href="phased-deployments.html" title="Phased Deployments">Phased Deployments</a></li>
            <li><a href="incremental-change-code-cleanup.html" title="Incremental Change Code Cleanup">Incremental Change Code Cleanup</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Onboarding Guide <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="onboarding-guide.html" title="Which onboarding to choose?">Which onboarding to choose?</a></li>
            <li><a href="new-onboarding-guide.html" title="New Systems">New Systems</a></li>
            <li><a href="existing-onboarding-guide.html" title="Existing Systems">Existing Systems</a></li>
            <li><a href="existing-diverging-onboarding-guide.html" title="Existing Systems with Diverging Shards">Existing Systems with Diverging Shards</a></li>
            <li><a href="legacy-onboarding-guide.html" title="Legacy Onboarding - Legacy Systems">Legacy Onboarding - Legacy Systems</a></li>
            <li><a href="db-merge-tool.html" title="DB Merge Tool">DB Merge Tool</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developer Information <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="developer-guide.html" title="Developer Guide">Developer Guide</a>
              <ul class="dropdown-menu">
                  <li><a href="dev-setup-amazon.html" title="Amazon RDS DB Setup">Amazon RDS DB Setup</a></li>
                  <li><a href="dev-setup-db2.html" title="DB2 Test DB Setup">DB2 Test DB Setup</a></li>
                  <li><a href="dev-setup-sybase-ase.html" title="Sybase ASE Test DB Setup">Sybase ASE Test DB Setup</a></li>
              </ul>
            </li>
            <li><a href="design-walkthrough.html" title="Design Walkthrough">Design Walkthrough</a></li>
        </ul>
      </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><a href="./" id="bannerLeft"><h2>Obevo</h2>
</a></div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li class=""><a href="./" title="Obevo">Obevo</a><span class="divider">/</span></li>
    <li class="active ">In-memory DB Conversion for Unit Testing</li>
        <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2017-12-04</li>
          <li id="projectVersion" class="pull-right">Version: 6.4.0</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Getting Started</li>
    <li><a href="index.html" title="Intro"><span class="none"></span>Intro</a>  </li>
    <li><a href="overview.html" title="Overview"><span class="none"></span>Overview</a>  </li>
    <li><a href="setup.html" title="Setup"><span class="none"></span>Setup</a>  </li>
    <li><a href="support.html" title="Help and Support"><span class="none"></span>Help and Support</a>  </li>
          <li class="nav-header">Technical Documentation</li>
    <li><a href="db-project-structure.html" title="DB Project Structure"><span class="none"></span>DB Project Structure</a>  </li>
    <li><a href="environment-management.html" title="Environment Management"><span class="none"></span>Environment Management</a>  </li>
    <li><a href="permission-management.html" title="Permission Management"><span class="none"></span>Permission Management</a>  </li>
    <li><a href="error-handling.html" title="Error-Handling"><span class="none"></span>Error-Handling</a>  </li>
    <li><a href="command-line-api.html" title="Command-line API"><span class="none"></span>Command-line API</a>  </li>
    <li><a href="java-api.html" title="Java API"><span class="none"></span>Java API</a>  </li>
    <li><a href="maven-api.html" title="Maven plugin API"><span class="none"></span>Maven plugin API</a>  </li>
    <li><a href="gradle-api.html" title="Gradle API"><span class="none"></span>Gradle API</a>  </li>
    <li><a href="faq.html" title="FAQs"><span class="none"></span>FAQs</a>  </li>
          <li class="nav-header">Advanced Topics</li>
    <li><a href="db-project-best-practices.html" title="DB Project Best Practices"><span class="none"></span>DB Project Best Practices</a>  </li>
    <li><a href="rollback.html" title="Rollback"><span class="none"></span>Rollback</a>  </li>
    <li><a href="multiple-schema-management.html" title="Multiple Schema Management"><span class="none"></span>Multiple Schema Management</a>  </li>
    <li class="active"><a href="#"><span class="none"></span>In-memory DB Testing</a>
  </li>
    <li><a href="parallel-deploy-execution.html" title="Parallel Deploy Execution"><span class="none"></span>Parallel Deploy Execution</a>  </li>
    <li><a href="orm-integration.html" title="ORM Integration"><span class="none"></span>ORM Integration</a>  </li>
    <li><a href="baseline-validation.html" title="Baseline DDL Validation"><span class="none"></span>Baseline DDL Validation</a>  </li>
    <li><a href="sybase-ase-notes.html" title="Sybase ASE Notes"><span class="none"></span>Sybase ASE Notes</a>  </li>
    <li><a href="db2-notes.html" title="DB2 Notes"><span class="none"></span>DB2 Notes</a>  </li>
    <li><a href="phased-deployments.html" title="Phased Deployments"><span class="none"></span>Phased Deployments</a>  </li>
    <li><a href="incremental-change-code-cleanup.html" title="Incremental Change Code Cleanup"><span class="none"></span>Incremental Change Code Cleanup</a>  </li>
          <li class="nav-header">Onboarding Guide</li>
    <li><a href="onboarding-guide.html" title="Which onboarding to choose?"><span class="none"></span>Which onboarding to choose?</a>  </li>
    <li><a href="new-onboarding-guide.html" title="New Systems"><span class="none"></span>New Systems</a>  </li>
    <li><a href="existing-onboarding-guide.html" title="Existing Systems"><span class="none"></span>Existing Systems</a>  </li>
    <li><a href="existing-diverging-onboarding-guide.html" title="Existing Systems with Diverging Shards"><span class="none"></span>Existing Systems with Diverging Shards</a>  </li>
    <li><a href="legacy-onboarding-guide.html" title="Legacy Onboarding - Legacy Systems"><span class="none"></span>Legacy Onboarding - Legacy Systems</a>  </li>
    <li><a href="db-merge-tool.html" title="DB Merge Tool"><span class="none"></span>DB Merge Tool</a>  </li>
          <li class="nav-header">Developer Information</li>
    <li><a href="developer-guide.html" title="Developer Guide"><span class="icon-chevron-down"></span>Developer Guide</a>
      <ul class="nav nav-list">
    <li><a href="dev-setup-amazon.html" title="Amazon RDS DB Setup"><span class="none"></span>Amazon RDS DB Setup</a>  </li>
    <li><a href="dev-setup-db2.html" title="DB2 Test DB Setup"><span class="none"></span>DB2 Test DB Setup</a>  </li>
    <li><a href="dev-setup-sybase-ase.html" title="Sybase ASE Test DB Setup"><span class="none"></span>Sybase ASE Test DB Setup</a>  </li>
      </ul>
  </li>
    <li><a href="design-walkthrough.html" title="Design Walkthrough"><span class="none"></span>Design Walkthrough</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >

    
        
            
            
        <ul>
<li><a href="#In-memory_DBs_for_unit_testing">In-memory DBs for unit testing</a></li>
<li><a href="#Manually_defining_a_translation_SQL">Manually defining a translation SQL</a></li></ul>
        
<div class="section">
<h2><a name="In-memory_DBs_for_unit_testing"></a>In-memory DBs for unit testing</h2>
            
<p>Obevo can create an in-memory db from your existing SQLs, thus guaranteeing that the same
            DDLs you use to deploy to prod are the same ones for your testing</p>

            Some translation happens to ensure that your prod SQLs work against an in-mem environment (notably to
            simplify some SQLs, as we don't need to support as much rich logic in an in-mem environment)
            
<ul>
                
<li>Stored Procedures, Functions, and Triggers are not deployed (very hard to unit-test these, or the SQL varies too much between the live dbs and the in-memory dbs)</li>
                
<li>See the other translations done in the class InMemoryTranslator. These include:
                    
<ul>
                        
<li>Removing &quot;lock data rows&quot; and such from Sybase</li>
                        
<li>Removing mentions of &quot;clustered&quot; for indices</li>
                    </ul>
                </li>
            </ul>

            
<p>You have two options to convert to an in-memory database:</p>

            
<div class="section">
<h3><a name="Option_1_-_use_the_inMemoryDbType_variable_in_your_system-config.xml"></a>Option 1 - use the inMemoryDbType variable in your system-config.xml</h3>
                
<p>In your system-config.xml, you define the type for your system via the &quot;dbSystemConfig type=&quot;SYBASE_ASE&quot;&quot;.</p>

                
<p>At the dbEnvironment level, you can then specify the inMemoryDbType to facilitate the conversion from the
                    system type to the in-memory environment type, per the example below.
                </p>

                
<p>You can then use the standard DbEnvironmentFactory API to access the environment and build the DbDeployerAppContext.</p>

                
<p>
                    <b>HOWEVER</b>, if you are re-creating the DB across tests, please reuse the DbDeployerAppContext instance
                    as to save time in reloading your db files from disk.
                </p>


                
<div class="source"><pre class="prettyprint">&lt;dbEnvironment name=&quot;BOSI_A_1&quot;
            cleanBuildAllowed=&quot;true&quot;
            jdbcUrl=&quot;jdbc:hsqldb:mem:unit1inmem&quot; inMemoryDbType=&quot;HSQL&quot;
            defaultUserId=&quot;sa&quot;
            defaultPassword=&quot;&quot;
            &gt;
</pre></div>
            </div>
            
<div class="section">
<h3><a name="Option_2_-_Use_the_UnitTestDbBuilder_to_convert_the_environment_in_memory"></a>Option 2 - Use the UnitTestDbBuilder to convert the environment in memory</h3>
                
<p>There is a wrapper API also available to build the in-memory database by using a reference env from
                    your environments and optionally overriding some values.
                </p>

                
<p>This option
                    <b>
                        <i>will cache the reads from file disk</i>
                    </b>
                    , so no need for you to reuse the DbDeployerAppContext
                    from the wrapper API
                </p>

                You can just include this in maven to get access to the utility:
                
<div class="source"><pre class="prettyprint">&lt;properties&gt;
    &lt;obevo.version&gt;${project.version}&lt;/obevo.version&gt;
&lt;/properties&gt;
...
&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.goldmansachs.obevo&lt;/groupId&gt;
        &lt;artifactId&gt;obevo-db-unittest&lt;/artifactId&gt;
        &lt;version&gt;${obevo.version}&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.goldmansachs.obevo&lt;/groupId&gt;
        &lt;artifactId&gt;obevo-db-hsql&lt;/artifactId&gt;  &lt;!-- or obevo-db-h2 --&gt;
        &lt;version&gt;${obevo.version}&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</pre></div>

                And here is some sample code to build the DB:
                
<div class="source"><pre class="prettyprint">DbDeployerAppContext context = UnitTestDbBuilder.newBuilder()
    .setSourcePath(&quot;platforms/db2/step1&quot;)
    .setReferenceEnvName(&quot;unittestrefh2&quot;)  // mention the environment name that you want to model off
    .setEnvName(&quot;myUnitTestDb&quot;)  // optionally - rename the environment if you are changing it from the reference
    .setDbPlatform(new H2DbPlatform())  // you can override the platform in code, or do it in the XML as mentioned in option 1
    .setDbServer(&quot;mydb2testH2&quot;)  // setting this value is a shortcut to generate the JDBC url for this environment for you if not already specified
    .buildContext();

// Once you have the reference to the DbDeployerAppContext, the code remains the same.
context.setupEnvInfra();
context.cleanEnvironment();
context.deploy();

System.out.println(&quot;This is my JDBC url for reference - &quot; + context.getEnvironment().getJdbcUrl());</pre></div>
            </div>
        </div>
        
<div class="section">
<h2><a name="Manually_defining_a_translation_SQL"></a>Manually defining a translation SQL</h2>
            
<p>The translation logic works for most cases, but at times it will not.</p>

            
<p>To define your own SQL, leverage the include/exclude platforms functionality to define the SQL for your
                regular environments separately from the in-memory environments, e.g.
            </p>
            
<div class="source"><pre class="prettyprint">
//// CHANGE name=&quot;myChange&quot; excludePlatforms=&quot;HSQL,H2&quot;
My DB2-compatible SQL

//// CHANGE name=&quot;myChange&quot; includePlatforms=&quot;HSQL,H2&quot;
My in-memory-compatible SQL</pre></div>
        </div>
    

        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2017
<a href="http://www.goldmansachs.com/">Goldman Sachs</a>.
All rights reserved.</p>
        </div>
        </div>
    </footer>
    </body>
</html>
