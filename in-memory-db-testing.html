<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.6 at 2017-04-26 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>obevo-site &#x2013; In-memory DB Conversion for Unit Testing</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20170426" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                obevo-site
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                    
                <div class="xleft">
        <span id="publishDate">Last Published: 2017-04-26</span>
                  &nbsp;| <span id="projectVersion">Version: 6.0.0-SNAPSHOT</span>
                      </div>
            <div class="xright">                    <a href="./" title="obevo-site">obevo-site</a>
              
                    
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                    
                                <h5>Parent Project</h5>
                  <ul>
                  <li class="none">
                          <a href="../index.html" title="Obevo Parent POM">Obevo Parent POM</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                                                                            <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                   
                    
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <!-- Copyright 2017 Goldman Sachs.
    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License. -->
    
        
            
            
        <ul>
<li><a href="#In-memory_DBs_for_unit_testing">In-memory DBs for unit testing</a></li>
<li><a href="#Manually_defining_a_translation_SQL">Manually defining a translation SQL</a></li></ul>
        
<div class="section">
<h2><a name="In-memory_DBs_for_unit_testing"></a>In-memory DBs for unit testing</h2>
            
<p>Obevo can create an in-memory db from your existing SQLs, thus guaranteeing that the same
            DDLs you use to deploy to prod are the same ones for your testing</p>

            Some translation happens to ensure that your prod SQLs work against an in-mem environment (notably to
            simplify some SQLs, as we don't need to support as much rich logic in an in-mem environment)
            
<ul>
                
<li>Stored Procedures, Functions, and Triggers are not deployed (very hard to unit-test these, or the SQL varies too much between the live dbs and the in-memory dbs)</li>
                
<li>See the other translations done in the class InMemoryTranslator. These include:
                    
<ul>
                        
<li>Removing &quot;lock data rows&quot; and such from Sybase</li>
                        
<li>Removing mentions of &quot;clustered&quot; for indices</li>
                    </ul>
                </li>
            </ul>

            
<p>You have two options to convert to an in-memory database:</p>

            
<div class="section">
<h3><a name="Option_1_-_use_the_inMemoryDbType_variable_in_your_system-config.xml"></a>Option 1 - use the inMemoryDbType variable in your system-config.xml</h3>
                
<p>In your system-config.xml, you define the type for your system via the &quot;dbSystemConfig type=&quot;SYBASE_ASE&quot;&quot;.</p>

                
<p>At the dbEnvironment level, you can then specify the inMemoryDbType to facilitate the conversion from the
                    system type to the in-memory environment type, per the example below.
                </p>

                
<p>You can then use the standard DbEnvironmentFactory API to access the environment and build the DbDeployerAppContext.</p>

                
<p>
                    <b>HOWEVER</b>, if you are re-creating the DB across tests, please reuse the DbDeployerAppContext instance
                    as to save time in reloading your db files from disk.
                </p>


                
<div class="source">
<pre>&lt;dbEnvironment name=&quot;BOSI_A_1&quot;
            cleanBuildAllowed=&quot;true&quot;
            jdbcUrl=&quot;jdbc:hsqldb:mem:unit1inmem&quot; inMemoryDbType=&quot;HSQL&quot;
            defaultUserId=&quot;sa&quot;
            defaultPassword=&quot;&quot;
            &gt;
</pre></div>
            </div>
            
<div class="section">
<h3><a name="Option_2_-_Use_the_UnitTestDbBuilder_to_convert_the_environment_in_memory"></a>Option 2 - Use the UnitTestDbBuilder to convert the environment in memory</h3>
                
<p>There is a wrapper API also available to build the in-memory database by using a reference env from
                    your environments and optionally overriding some values.
                </p>

                
<p>This option
                    <b>
                        <i>will cache the reads from file disk</i>
                    </b>
                    , so no need for you to reuse the DbDeployerAppContext
                    from the wrapper API
                </p>

                You can just include this in maven to get access to the utility:
                
<div class="source">
<pre>&lt;properties&gt;
    &lt;obevo.version&gt;${project.version}&lt;/obevo.version&gt;
&lt;/properties&gt;
...
&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.goldmansachs.obevo&lt;/groupId&gt;
        &lt;artifactId&gt;obevo-db-unittest&lt;/artifactId&gt;
        &lt;version&gt;${obevo.version}&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.goldmansachs.obevo&lt;/groupId&gt;
        &lt;artifactId&gt;obevo-db-hsql&lt;/artifactId&gt;  &lt;!-- or obevo-db-h2 --&gt;
        &lt;version&gt;${obevo.version}&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</pre></div>

                And here is some sample code to build the DB:
                
<div class="source">
<pre>DbDeployerAppContext context = UnitTestDbBuilder.newBuilder()
    .setSourcePath(&quot;platforms/db2/step1&quot;)
    .setReferenceEnvName(&quot;unittestrefh2&quot;)  // mention the environment name that you want to model off
    .setEnvName(&quot;myUnitTestDb&quot;)  // optionally - rename the environment if you are changing it from the reference
    .setDbPlatform(new H2DbPlatform())  // you can override the platform in code, or do it in the XML as mentioned in option 1
    .setDbServer(&quot;mydb2testH2&quot;)  // setting this value is a shortcut to generate the JDBC url for this environment for you if not already specified
    .buildContext();

// Once you have the reference to the DbDeployerAppContext, the code remains the same.
context.setupEnvInfra();
context.cleanEnvironment();
context.deploy();

System.out.println(&quot;This is my JDBC url for reference - &quot; + context.getEnvironment().getJdbcUrl());</pre></div>
            </div>
        </div>
        
<div class="section">
<h2><a name="Manually_defining_a_translation_SQL"></a>Manually defining a translation SQL</h2>
            
<p>The translation logic works for most cases, but at times it will not.</p>

            
<p>To define your own SQL, leverage the include/exclude platforms functionality to define the SQL for your
                regular environments separately from the in-memory environments, e.g.
            </p>
            
<div class="source">
<pre>
//// CHANGE name=&quot;myChange&quot; excludePlatforms=&quot;HSQL,H2&quot;
My DB2-compatible SQL

//// CHANGE name=&quot;myChange&quot; includePlatforms=&quot;HSQL,H2&quot;
My in-memory-compatible SQL</pre></div>
        </div>
    

      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2017
                        <a href="http://www.goldmansachs.com/">Goldman Sachs</a>.
            All rights reserved.      
                    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
